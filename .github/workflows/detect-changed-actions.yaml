name: Detect Changed Action

on:
  push:
    branches:
      - main

permissions:
  pull-requests: write
  contents: write
  id-token: write
  checks: write
  actions: write
  security-events: write

env:
  GITHUB_TOKEN: ${{ secrets.GHUB_TOKEN }}

jobs:

  detect-changed-action:
    name: Detect Changed Actions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: â‡£ Search for changed actions
        shell: bash
        id: config
        run: |
          pr_num=`git log --grep="Merge pull request #[0-9]\+" --pretty=oneline -1| sed -En "s/.*#([[:digit:]]+).*/\1/p"`
          files=`gh pr diff $pr_num --name-only| grep -v '(.github|README)'`
          latest_tag=`git describe --tags --abbrev=0`
          for file in $files; do
            action_name=`dirname $file`
            grep -rl "$action_name@' . | xargs sed -i "s|$action_name@.*|$action_name@$latest_tag|g"
          done 
